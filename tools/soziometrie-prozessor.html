// Speichere in: js/soziometrie-processor.js

/**
 * Verarbeitet soziometrische Daten und erstellt anonymisierte Versionen
 * für die Verwendung in KI-Prompts
 */
class SoziometrieProcessor {
  constructor() {
    this.rawData = null;
    this.anonymizedData = null;
    this.metadata = null;
    this.mappings = null;
  }
  
  // Verarbeitet CSV-Daten und erstellt anonymisierte Version
  processCSV(csvContent, nameField) {
    // CSV parsen
    const data = this.parseCSV(csvContent);
    this.rawData = data;
    
    // Pseudonymisierung mit Mapping
    const processed = this.pseudonymizeData(data.data, nameField);
    this.anonymizedData = processed.processedData;
    this.mappings = processed.mappings;
    
    // Metadaten erstellen (keine personenbezogenen Daten)
    this.metadata = this.generateMetadata(data, processed);
    
    return {
      anonymizedData: this.anonymizedData,
      metadata: this.metadata
    };
  }
  
  // Speichert Daten lokal (Browser Storage, kein Server)
  saveLocally() {
    // Speichere anonymisierte Daten und Metadaten
    localStorage.setItem('soziometrie_anonymized', JSON.stringify(this.anonymizedData));
    localStorage.setItem('soziometrie_metadata', JSON.stringify(this.metadata));
    
    // Verschlüsselte Speicherung der Mappings (nur für den Lehrer)
    const encryptedMappings = this.encryptForTeacher(this.mappings);
    localStorage.setItem('soziometrie_mappings', encryptedMappings);
    
    return {
      anonymizedFilePath: 'data/soziometrie/class-data.anonymous.json',
      metadataFilePath: 'data/soziometrie/class-data.metadata.json'
    };
  }
  
  // Pseudonymisierung mit Lehrer-Entschlüsselung
  pseudonymizeData(data, nameField) {
    const pseudonyms = {};
    const reverseMapping = {};
    
    // Prozessierte Daten mit Vornamen oder Vorname + Initial
    const processedData = data.map(row => {
      const newRow = {...row};
      
      if (newRow[nameField]) {
        const fullName = newRow[nameField];
        let displayName = this.getFirstName(fullName);
        
        // Vornamenduplikate mit Nachnameninitial versehen
        if (pseudonyms[displayName]) {
          const initial = this.getLastNameInitial(fullName);
          displayName = `${displayName} ${initial}.`;
        }
        
        pseudonyms[displayName] = fullName;
        reverseMapping[fullName] = displayName;
        newRow[nameField] = displayName;
      }
      
      return newRow;
    });
    
    return {
      processedData,
      mappings: {
        original: pseudonyms, // Anzeigename -> Originalname
        display: reverseMapping // Originalname -> Anzeigename
      }
    };
  }
  
  // Erzeugt nicht-personenbezogene Metadaten
  generateMetadata(rawData, processedData) {
    return {
      classSize: rawData.data.length,
      timestamp: new Date().toISOString(),
      socialMetrics: {
        isolatedCount: this.countIsolatedStudents(processedData.processedData),
        popularCount: this.countPopularStudents(processedData.processedData),
        groupCount: this.identifyGroups(processedData.processedData).length
      },
      preferenceDistribution: this.analyzePreferences(processedData.processedData),
      version: "1.0"
    };
  }
  
  // Hilfsmethoden
  getFirstName(fullName) {
    return fullName.split(' ')[0];
  }
  
  getLastNameInitial(fullName) {
    const parts = fullName.split(' ');
    return parts.length > 1 ? parts[parts.length - 1].charAt(0) : '';
  }
  
  // Verschlüsselung nur für lokale Speicherung
  encryptForTeacher(data) {
    // Einfache Verschlüsselung für lokale Speicherung
    return btoa(JSON.stringify(data));
  }
  
  // Analytische Methoden
  countIsolatedStudents(data) { /* Implementierung */ }
  countPopularStudents(data) { /* Implementierung */ }
  identifyGroups(data) { /* Implementierung */ }
  analyzePreferences(data) { /* Implementierung */ }
  
  // CSV-Parser
  parseCSV(csvContent) { /* Implementierung */ }
}